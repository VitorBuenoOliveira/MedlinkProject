<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Ambul칙ncias Pr칩ximas</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .ambulance-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ambulance-card h3 {
            margin-top: 0;
            color: #d32f2f;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.disponivel { background: #4caf50; color: white; }
        .status.em-transito { background: #ff9800; color: white; }
        .status.ocupada { background: #f44336; color: white; }
        .status.em-manutencao { background: #9e9e9e; color: white; }
        #ambulance-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/client_management.html">Clientes</a>
        <a href="/motorista_registration.html">Motoristas</a>
        <a href="/ambulancia_registration.html">Ambul칙ncias</a>
        <a href="/hospital_registration.html">Hospitais</a>
        <a href="/usuario_registration.html">Usu치rios</a>
        <a href="/scheduling.html">Agendamento</a>
        <a href="/reports.html">Relat칩rios</a>
        <a href="/geolocation.html">Geolocaliza칞칚o</a>
        <a href="/map.html">Mapa Pr칩ximo</a>
    </nav>

    <h1>Mapa de Ambul칙ncias Pr칩ximas 游뚬</h1>

    <div id="map"></div>

    <div id="ambulance-list">
        <h2>Ambul칙ncias Pr칩ximas</h2>
        <!-- Lista ser치 preenchida dinamicamente -->
    </div>

    <script>
        let userLocation = { lat: -23.5505, lng: -46.6333 }; // Default S칚o Paulo
        let ambulancias = [];
        let markers = [];
        let map;

        // Obt칠m localiza칞칚o do usu치rio
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        initMap();
                        fetchAmbulancias();
                    },
                    (error) => {
                        console.log('Erro ao obter localiza칞칚o:', error);
                        initMap();
                        fetchAmbulancias();
                    }
                );
            } else {
                initMap();
                fetchAmbulancias();
            }
        }

        async function fetchAmbulancias() {
            try {
                const response = await fetch('/ambulancias/combined');
                ambulancias = await response.json();
                // Simula ambul칙ncias pr칩ximas ao usu치rio
                ambulancias = ambulancias.map((amb, index) => ({
                    ...amb,
                    latitude: userLocation.lat + (Math.random() - 0.5) * 0.01,
                    longitude: userLocation.lng + (Math.random() - 0.5) * 0.01
                }));
                updateMap();
                updateAmbulanceList();
            } catch (error) {
                console.error('Erro ao buscar ambul칙ncias:', error);
                // Fallback para dados fict칤cios
                ambulancias = [
                    { ambulanciaId: 1, placa: 'ABC-1234', modelo: 'Fiat Ducato', capacidade: 4, status: 'Dispon칤vel', latitude: userLocation.lat + 0.002, longitude: userLocation.lng + 0.002, motoristaId: 1, motoristaNome: 'Jo칚o Silva', motoristaTelefone: '(11) 99999-9999' },
                    { ambulanciaId: 2, placa: 'DEF-5678', modelo: 'Mercedes Sprinter', capacidade: 6, status: 'Em tr칙nsito', latitude: userLocation.lat - 0.001, longitude: userLocation.lng + 0.003, motoristaId: 2, motoristaNome: 'Maria Santos', motoristaTelefone: '(11) 88888-8888' },
                    { ambulanciaId: 3, placa: 'GHI-9012', modelo: 'VW Crafter', capacidade: 8, status: 'Ocupada', latitude: userLocation.lat + 0.003, longitude: userLocation.lng - 0.002, motoristaId: null, motoristaNome: null, motoristaTelefone: null },
                    { ambulanciaId: 4, placa: 'JKL-3456', modelo: 'Iveco Daily', capacidade: 5, status: 'Dispon칤vel', latitude: userLocation.lat - 0.002, longitude: userLocation.lng - 0.001, motoristaId: 3, motoristaNome: 'Pedro Oliveira', motoristaTelefone: '(11) 77777-7777' },
                    { ambulanciaId: 5, placa: 'MNO-7890', modelo: 'Fiat Ducato', capacidade: 4, status: 'Em manuten칞칚o', latitude: userLocation.lat + 0.001, longitude: userLocation.lng + 0.004, motoristaId: 4, motoristaNome: 'Ana Costa', motoristaTelefone: '(11) 66666-6666' }
                ];
                updateMap();
                updateAmbulanceList();
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: userLocation
            });

            // Marcador da localiza칞칚o do usu치rio
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Sua Localiza칞칚o',
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/shapes/man.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
        }

        function updateMap() {
            // Remove marcadores antigos
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            ambulancias.forEach(ambulancia => {
                const marker = new google.maps.Marker({
                    position: { lat: ambulancia.latitude, lng: ambulancia.longitude },
                    map: map,
                    title: `Ambul칙ncia ${ambulancia.placa}`
                });

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<br><strong>Motorista:</strong> ${ambulancia.motoristaNome}<br><strong>Telefone:</strong> ${ambulancia.motoristaTelefone || 'N/A'}` :
                    '<br><strong>Motorista:</strong> N칚o atribu칤do';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width: 300px;">
                            <h4>Ambul칙ncia ${ambulancia.placa}</h4>
                            <p><strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                            <p><strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                            <p><strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                            ${motoristaInfo}
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        function updateAmbulanceList() {
            const listContainer = document.getElementById('ambulance-list');
            listContainer.innerHTML = '<h2>Ambul칙ncias Pr칩ximas</h2>';

            ambulancias.forEach(ambulancia => {
                const card = document.createElement('div');
                card.className = 'ambulance-card';

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<p><strong>Motorista:</strong> ${ambulancia.motoristaNome} - ${ambulancia.motoristaTelefone || 'N/A'}</p>` :
                    '<p><strong>Motorista:</strong> N칚o atribu칤do</p>';

                card.innerHTML = `
                    <h3>${ambulancia.placa}</h3>
                    <p><strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                    <p><strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                    <p><strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                    ${motoristaInfo}
                `;

                listContainer.appendChild(card);
            });
        }

        // Inicia o carregamento
        getUserLocation();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIz6iI0blYnCpoGhjstXvYbxdVdyHRWpo&callback=getUserLocation"></script>
</body>
</html>
