<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Ambul칙ncias Pr칩ximas</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="chatbot.css">
</head>
<body class="has-sidebar">
    <!-- Top Header Bar -->
    <div class="top-header">
        <div class="header-left">
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/home.html" class="home-btn">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="header-right">
            <div class="user-header-profile">
                <div class="user-avatar-small">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info-small">
                    <span class="user-name">Admin User</span>
                    <span class="user-email">admin@medilink.com</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar (injected by JavaScript) -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

    

    <div class="container">
        <h1>Mapa de Ambul칙ncias Pr칩ximas 游뚬</h1>

        <div id="map"></div>

        <div id="ambulance-list">
            <h2><i class="fas fa-ambulance"></i> Ambul칙ncias Pr칩ximas</h2>
            <!-- Lista ser치 preenchida dinamicamente -->
        </div>
    </div>

    <script>
        let userLocation = { lat: -23.5505, lng: -46.6333 }; // Default S칚o Paulo
        let ambulancias = [];
        let markers = [];
        let map;

        // Obt칠m localiza칞칚o do usu치rio
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        initMap();
                        fetchAmbulancias();
                    },
                    (error) => {
                        console.log('Erro ao obter localiza칞칚o:', error);
                        initMap();
                        fetchAmbulancias();
                    }
                );
            } else {
                initMap();
                fetchAmbulancias();
            }
        }

        async function fetchAmbulancias() {
            try {
                const response = await fetch('/ambulancias/combined');
                ambulancias = await response.json();
                // Simula ambul칙ncias pr칩ximas ao usu치rio
                ambulancias = ambulancias.map((amb, index) => ({
                    ...amb,
                    latitude: userLocation.lat + (Math.random() - 0.5) * 0.01,
                    longitude: userLocation.lng + (Math.random() - 0.5) * 0.01
                }));
                updateMap();
                updateAmbulanceList();
            } catch (error) {
                console.error('Erro ao buscar ambul칙ncias:', error);
                // Fallback para dados fict칤cios
                ambulancias = [
                    { ambulanciaId: 1, placa: 'ABC-1234', modelo: 'Fiat Ducato', capacidade: 4, status: 'Dispon칤vel', latitude: userLocation.lat + 0.002, longitude: userLocation.lng + 0.002, motoristaId: 1, motoristaNome: 'Jo칚o Silva', motoristaTelefone: '(11) 99999-9999' },
                    { ambulanciaId: 2, placa: 'DEF-5678', modelo: 'Mercedes Sprinter', capacidade: 6, status: 'Em tr칙nsito', latitude: userLocation.lat - 0.001, longitude: userLocation.lng + 0.003, motoristaId: 2, motoristaNome: 'Maria Santos', motoristaTelefone: '(11) 88888-8888' },
                    { ambulanciaId: 3, placa: 'GHI-9012', modelo: 'VW Crafter', capacidade: 8, status: 'Ocupada', latitude: userLocation.lat + 0.003, longitude: userLocation.lng - 0.002, motoristaId: null, motoristaNome: null, motoristaTelefone: null },
                    { ambulanciaId: 4, placa: 'JKL-3456', modelo: 'Iveco Daily', capacidade: 5, status: 'Dispon칤vel', latitude: userLocation.lat - 0.002, longitude: userLocation.lng - 0.001, motoristaId: 3, motoristaNome: 'Pedro Oliveira', motoristaTelefone: '(11) 77777-7777' },
                    { ambulanciaId: 5, placa: 'MNO-7890', modelo: 'Fiat Ducato', capacidade: 4, status: 'Em manuten칞칚o', latitude: userLocation.lat + 0.001, longitude: userLocation.lng + 0.004, motoristaId: 4, motoristaNome: 'Ana Costa', motoristaTelefone: '(11) 66666-6666' }
                ];
                updateMap();
                updateAmbulanceList();
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: userLocation
            });

            // Marcador da localiza칞칚o do usu치rio
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Sua Localiza칞칚o',
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/shapes/man.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
        }

        function updateMap() {
            // Remove marcadores antigos
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            ambulancias.forEach(ambulancia => {
                const marker = new google.maps.Marker({
                    position: { lat: ambulancia.latitude, lng: ambulancia.longitude },
                    map: map,
                    title: `Ambul칙ncia ${ambulancia.placa}`
                });

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<br><strong>Motorista:</strong> ${ambulancia.motoristaNome}<br><strong>Telefone:</strong> ${ambulancia.motoristaTelefone || 'N/A'}` :
                    '<br><strong>Motorista:</strong> N칚o atribu칤do';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width: 300px;">
                            <h4>Ambul칙ncia ${ambulancia.placa}</h4>
                            <p><strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                            <p><strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                            <p><strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                            ${motoristaInfo}
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        function updateAmbulanceList() {
            const listContainer = document.getElementById('ambulance-list');
            listContainer.innerHTML = '<h2><i class="fas fa-ambulance"></i> Ambul칙ncias Pr칩ximas</h2>';

            ambulancias.forEach(ambulancia => {
                const card = document.createElement('div');
                card.className = 'ambulance-card';

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<p><i class="fas fa-user-tie"></i> <strong>Motorista:</strong> ${ambulancia.motoristaNome} - ${ambulancia.motoristaTelefone || 'N/A'}</p>` :
                    '<p><i class="fas fa-user-slash"></i> <strong>Motorista:</strong> N칚o atribu칤do</p>';

                card.innerHTML = `
                    <h3><i class="fas fa-ambulance"></i> ${ambulancia.placa}</h3>
                    <p><i class="fas fa-car"></i> <strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                    <p><i class="fas fa-users"></i> <strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                    <p><i class="fas fa-info-circle"></i> <strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                    ${motoristaInfo}
                `;

                listContainer.appendChild(card);
            });
        }

        // Inicia o carregamento
        getUserLocation();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIz6iI0blYnCpoGhjstXvYbxdVdyHRWpo&callback=getUserLocation"></script>
    </main>

    <script src="sidebar.js"></script>
    <script>
        // Inject sidebar
        document.getElementById('sidebar-container').innerHTML = createSidebar('map');
        
        // Apply saved theme
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        }
        
        // Apply accessibility settings
        const highContrast = localStorage.getItem('highContrast') === 'true';
        const largeText = localStorage.getItem('largeText') === 'true';
        
        if (highContrast) {
            document.body.classList.add('high-contrast');
        }
        if (largeText) {
            document.body.classList.add('large-text');
        }
    </script>
    <script src="chatbot.js"></script>
</body>
</html>
