<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Ambul칙ncias Pr칩ximas</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .ambulance-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .ambulance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }
        .ambulance-card h3 {
            margin-top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.3rem;
        }
        .status {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        .status.disponivel { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #155724; }
        .status.em-transito { background: linear-gradient(135deg, #ffd89b 0%, #ffb347 100%); color: #7c3e00; }
        .status.ocupada { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #721c24; }
        .status.em-manutencao { background: linear-gradient(135deg, #a8caba 0%, #5d4e6d 100%); color: white; }
        #ambulance-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <nav>
        <img src="medilink_logo.png" alt="MediLink Logo" class="logo" />
        <a href="/dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/client_management.html"><i class="fas fa-users"></i> Clientes</a>
        <a href="/motorista_registration.html"><i class="fas fa-user-tie"></i> Motoristas</a>
        <a href="/ambulancia_registration.html"><i class="fas fa-ambulance"></i> Ambul칙ncias</a>
        <a href="/hospital_registration.html"><i class="fas fa-hospital"></i> Hospitais</a>
        <a href="/usuario_registration.html"><i class="fas fa-user-plus"></i> Usu치rios</a>
        <a href="/scheduling.html"><i class="fas fa-calendar-alt"></i> Agendamento</a>
        <a href="/reports.html"><i class="fas fa-chart-bar"></i> Relat칩rios</a>
        <a href="/geolocation.html"><i class="fas fa-map-marker-alt"></i> Geolocaliza칞칚o</a>
        <a href="/map.html"><i class="fas fa-map"></i> Mapa Pr칩ximo</a>
    </nav>

    <div class="container">
        <h1>Mapa de Ambul칙ncias Pr칩ximas 游뚬</h1>

        <div id="map"></div>

        <div id="ambulance-list">
            <h2><i class="fas fa-ambulance"></i> Ambul칙ncias Pr칩ximas</h2>
            <!-- Lista ser치 preenchida dinamicamente -->
        </div>
    </div>

    <script>
        let userLocation = { lat: -23.5505, lng: -46.6333 }; // Default S칚o Paulo
        let ambulancias = [];
        let markers = [];
        let map;

        // Obt칠m localiza칞칚o do usu치rio
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        initMap();
                        fetchAmbulancias();
                    },
                    (error) => {
                        console.log('Erro ao obter localiza칞칚o:', error);
                        initMap();
                        fetchAmbulancias();
                    }
                );
            } else {
                initMap();
                fetchAmbulancias();
            }
        }

        async function fetchAmbulancias() {
            try {
                const response = await fetch('/ambulancias/combined');
                ambulancias = await response.json();
                // Simula ambul칙ncias pr칩ximas ao usu치rio
                ambulancias = ambulancias.map((amb, index) => ({
                    ...amb,
                    latitude: userLocation.lat + (Math.random() - 0.5) * 0.01,
                    longitude: userLocation.lng + (Math.random() - 0.5) * 0.01
                }));
                updateMap();
                updateAmbulanceList();
            } catch (error) {
                console.error('Erro ao buscar ambul칙ncias:', error);
                // Fallback para dados fict칤cios
                ambulancias = [
                    { ambulanciaId: 1, placa: 'ABC-1234', modelo: 'Fiat Ducato', capacidade: 4, status: 'Dispon칤vel', latitude: userLocation.lat + 0.002, longitude: userLocation.lng + 0.002, motoristaId: 1, motoristaNome: 'Jo칚o Silva', motoristaTelefone: '(11) 99999-9999' },
                    { ambulanciaId: 2, placa: 'DEF-5678', modelo: 'Mercedes Sprinter', capacidade: 6, status: 'Em tr칙nsito', latitude: userLocation.lat - 0.001, longitude: userLocation.lng + 0.003, motoristaId: 2, motoristaNome: 'Maria Santos', motoristaTelefone: '(11) 88888-8888' },
                    { ambulanciaId: 3, placa: 'GHI-9012', modelo: 'VW Crafter', capacidade: 8, status: 'Ocupada', latitude: userLocation.lat + 0.003, longitude: userLocation.lng - 0.002, motoristaId: null, motoristaNome: null, motoristaTelefone: null },
                    { ambulanciaId: 4, placa: 'JKL-3456', modelo: 'Iveco Daily', capacidade: 5, status: 'Dispon칤vel', latitude: userLocation.lat - 0.002, longitude: userLocation.lng - 0.001, motoristaId: 3, motoristaNome: 'Pedro Oliveira', motoristaTelefone: '(11) 77777-7777' },
                    { ambulanciaId: 5, placa: 'MNO-7890', modelo: 'Fiat Ducato', capacidade: 4, status: 'Em manuten칞칚o', latitude: userLocation.lat + 0.001, longitude: userLocation.lng + 0.004, motoristaId: 4, motoristaNome: 'Ana Costa', motoristaTelefone: '(11) 66666-6666' }
                ];
                updateMap();
                updateAmbulanceList();
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: userLocation
            });

            // Marcador da localiza칞칚o do usu치rio
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Sua Localiza칞칚o',
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/shapes/man.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
        }

        function updateMap() {
            // Remove marcadores antigos
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            ambulancias.forEach(ambulancia => {
                const marker = new google.maps.Marker({
                    position: { lat: ambulancia.latitude, lng: ambulancia.longitude },
                    map: map,
                    title: `Ambul칙ncia ${ambulancia.placa}`
                });

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<br><strong>Motorista:</strong> ${ambulancia.motoristaNome}<br><strong>Telefone:</strong> ${ambulancia.motoristaTelefone || 'N/A'}` :
                    '<br><strong>Motorista:</strong> N칚o atribu칤do';

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width: 300px;">
                            <h4>Ambul칙ncia ${ambulancia.placa}</h4>
                            <p><strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                            <p><strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                            <p><strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                            ${motoristaInfo}
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        function updateAmbulanceList() {
            const listContainer = document.getElementById('ambulance-list');
            listContainer.innerHTML = '<h2><i class="fas fa-ambulance"></i> Ambul칙ncias Pr칩ximas</h2>';

            ambulancias.forEach(ambulancia => {
                const card = document.createElement('div');
                card.className = 'ambulance-card';

                const motoristaInfo = ambulancia.motoristaNome ?
                    `<p><i class="fas fa-user-tie"></i> <strong>Motorista:</strong> ${ambulancia.motoristaNome} - ${ambulancia.motoristaTelefone || 'N/A'}</p>` :
                    '<p><i class="fas fa-user-slash"></i> <strong>Motorista:</strong> N칚o atribu칤do</p>';

                card.innerHTML = `
                    <h3><i class="fas fa-ambulance"></i> ${ambulancia.placa}</h3>
                    <p><i class="fas fa-car"></i> <strong>Modelo:</strong> ${ambulancia.modelo || 'N/A'}</p>
                    <p><i class="fas fa-users"></i> <strong>Capacidade:</strong> ${ambulancia.capacidade || 'N/A'} pessoas</p>
                    <p><i class="fas fa-info-circle"></i> <strong>Status:</strong> <span class="status ${ambulancia.status.toLowerCase().replace(' ', '-')}">${ambulancia.status}</span></p>
                    ${motoristaInfo}
                `;

                listContainer.appendChild(card);
            });
        }

        // Inicia o carregamento
        getUserLocation();
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIz6iI0blYnCpoGhjstXvYbxdVdyHRWpo&callback=getUserLocation"></script>
</body>
</html>
