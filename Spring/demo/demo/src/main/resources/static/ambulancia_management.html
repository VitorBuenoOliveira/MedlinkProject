<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Ambul√¢ncias</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="has-sidebar">
    <!-- Top Header Bar -->
    <div class="top-header">
        <div class="header-left">
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/home.html" class="home-btn">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="header-right">
            <div class="user-header-profile">
                <div class="user-avatar-small">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info-small">
                    <span class="user-name">Admin User</span>
                    <span class="user-email">admin@medilink.com</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar (injected by JavaScript) -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

    

    <div class="container">
        <h1>Gerenciamento de Ambul√¢ncias üöë</h1>
        
        <table id="ambulanciasTable">
            <thead>
                <tr>
                    <th><i class="fas fa-car"></i> Placa</th>
                    <th><i class="fas fa-ambulance"></i> Modelo</th>
                    <th><i class="fas fa-users"></i> Capacidade</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-user-tie"></i> Motorista</th>
                    <th><i class="fas fa-cog"></i> A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando ambul√¢ncias...
                    </td>
                </tr>
            </tbody>
        </table>
        <div id="message" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <script>
        async function fetchAmbulancias() {
            try {
                const response = await fetch('/ambulancias/combined');
                const ambulancias = await response.json();
                renderTable(ambulancias);
            } catch (error) {
                console.error('Erro ao buscar ambul√¢ncias:', error);
                document.getElementById('message').innerHTML = '<span style="color: #e53e3e;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar ambul√¢ncias.</span>';
                document.querySelector('#ambulanciasTable tbody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: #e53e3e;">Erro ao carregar dados</td></tr>';
            }
        }

        function renderTable(ambulancias) {
            const tbody = document.querySelector('#ambulanciasTable tbody');
            tbody.innerHTML = '';

            if (ambulancias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma ambul√¢ncia cadastrada</td></tr>';
                return;
            }

            ambulancias.forEach(ambulancia => {
                const row = document.createElement('tr');
                const statusClass = ambulancia.status.toLowerCase().replace(' ', '-');

                row.innerHTML = `
                    <td>${ambulancia.placa}</td>
                    <td>${ambulancia.modelo || 'N/A'}</td>
                    <td>${ambulancia.capacidade || 'N/A'}</td>
                    <td><span class="status-${statusClass === 'dispon√≠vel' ? 'completed' : (statusClass === 'em-uso' || statusClass === 'ocupada' ? 'pending' : 'pending')}" style="padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">${ambulancia.status}</span></td>
                    <td>${ambulancia.motoristaNome || 'N√£o atribu√≠do'}</td>
                    <td>
                        ${ambulancia.motoristaId ? 
                            `<button onclick="removeDriver(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-user-times"></i> Remover Motorista</button>` : 
                            `<button onclick="assignDriver(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-user-plus"></i> Atribuir Motorista</button>`
                        }
                        ${ambulancia.status !== 'Em manuten√ß√£o' ? 
                            `<button onclick="setMaintenance(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #a8caba 0%, #5d4e6d 100%); margin-left: 5px;"><i class="fas fa-tools"></i> Manuten√ß√£o</button>` : ''
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        async function removeDriver(ambulanciaId) {
            if (!confirm('Tem certeza que deseja remover o motorista desta ambul√¢ncia?')) return;

            try {
                const response = await fetch(`/ambulancias/${ambulanciaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motoristaId: null })
                });

                if (response.ok) {
                    showMessage('‚úì Motorista removido com sucesso!', 'green');
                    fetchAmbulancias();
                } else {
                    showMessage('‚úó Erro ao remover motorista.', 'red');
                }
            } catch (error) {
                showMessage('‚úó Erro ao remover motorista.', 'red');
                console.error('Erro:', error);
            }
        }

        async function setMaintenance(ambulanciaId) {
            if (!confirm('Tem certeza que deseja colocar esta ambul√¢ncia em manuten√ß√£o?')) return;

            try {
                const response = await fetch(`/ambulancias/${ambulanciaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Em manuten√ß√£o' })
                });

                if (response.ok) {
                    showMessage('‚úì Ambul√¢ncia colocada em manuten√ß√£o!', 'green');
                    fetchAmbulancias();
                } else {
                    showMessage('‚úó Erro ao alterar status.', 'red');
                }
            } catch (error) {
                showMessage('‚úó Erro ao alterar status.', 'red');
                console.error('Erro:', error);
            }
        }

        function assignDriver(ambulanciaId) {
            // Redireciona para a p√°gina de associa√ß√£o
            window.location.href = `/ambulancia_motorista.html`;
        }

        function showMessage(text, color) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.style.color = color;
            messageDiv.style.fontWeight = 'bold';
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }

        // Carrega ambul√¢ncias ao carregar a p√°gina
        fetchAmbulancias();
    </script>
    </main>

    <script src="sidebar.js"></script>
    <script>
        // Inject sidebar
        document.getElementById('sidebar-container').innerHTML = createSidebar('ambulancia_management');
        
        // Apply saved theme
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        }
        
        // Apply accessibility settings
        const highContrast = localStorage.getItem('highContrast') === 'true';
        const largeText = localStorage.getItem('largeText') === 'true';
        
        if (highContrast) {
            document.body.classList.add('high-contrast');
        }
        if (largeText) {
            document.body.classList.add('large-text');
        }
    </script>
</body>
</html>
