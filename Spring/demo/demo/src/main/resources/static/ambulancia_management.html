<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Ambul√¢ncias</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <nav>
        <img src="medilink_logo.png" alt="MediLink Logo" class="logo" />
        <a href="/dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
        <a href="/client_management.html"><i class="fas fa-users"></i> Clientes</a>
        <a href="/motorista_registration.html"><i class="fas fa-user-tie"></i> Motoristas</a>
        <a href="/ambulancia_registration.html"><i class="fas fa-ambulance"></i> Ambul√¢ncias</a>
        <a href="/hospital_registration.html"><i class="fas fa-hospital"></i> Hospitais</a>
        <a href="/usuario_registration.html"><i class="fas fa-user-plus"></i> Usu√°rios</a>
        <a href="/scheduling.html"><i class="fas fa-calendar-alt"></i> Agendamento</a>
        <a href="/reports.html"><i class="fas fa-chart-bar"></i> Relat√≥rios</a>
    </nav>

    <div class="container">
        <h1>Gerenciamento de Ambul√¢ncias üöë</h1>
        
        <table id="ambulanciasTable">
            <thead>
                <tr>
                    <th><i class="fas fa-car"></i> Placa</th>
                    <th><i class="fas fa-ambulance"></i> Modelo</th>
                    <th><i class="fas fa-users"></i> Capacidade</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-user-tie"></i> Motorista</th>
                    <th><i class="fas fa-cog"></i> A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando ambul√¢ncias...
                    </td>
                </tr>
            </tbody>
        </table>
        <div id="message" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <script>
        async function fetchAmbulancias() {
            try {
                const response = await fetch('/ambulancias/combined');
                const ambulancias = await response.json();
                renderTable(ambulancias);
            } catch (error) {
                console.error('Erro ao buscar ambul√¢ncias:', error);
                document.getElementById('message').innerHTML = '<span style="color: #e53e3e;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar ambul√¢ncias.</span>';
                document.querySelector('#ambulanciasTable tbody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: #e53e3e;">Erro ao carregar dados</td></tr>';
            }
        }

        function renderTable(ambulancias) {
            const tbody = document.querySelector('#ambulanciasTable tbody');
            tbody.innerHTML = '';

            if (ambulancias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma ambul√¢ncia cadastrada</td></tr>';
                return;
            }

            ambulancias.forEach(ambulancia => {
                const row = document.createElement('tr');
                const statusClass = ambulancia.status.toLowerCase().replace(' ', '-');

                row.innerHTML = `
                    <td>${ambulancia.placa}</td>
                    <td>${ambulancia.modelo || 'N/A'}</td>
                    <td>${ambulancia.capacidade || 'N/A'}</td>
                    <td><span class="status-${statusClass === 'dispon√≠vel' ? 'completed' : (statusClass === 'em-uso' || statusClass === 'ocupada' ? 'pending' : 'pending')}" style="padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">${ambulancia.status}</span></td>
                    <td>${ambulancia.motoristaNome || 'N√£o atribu√≠do'}</td>
                    <td>
                        ${ambulancia.motoristaId ? 
                            `<button onclick="removeDriver(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-user-times"></i> Remover Motorista</button>` : 
                            `<button onclick="assignDriver(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-user-plus"></i> Atribuir Motorista</button>`
                        }
                        ${ambulancia.status !== 'Em manuten√ß√£o' ? 
                            `<button onclick="setMaintenance(${ambulancia.ambulanciaId})" style="background: linear-gradient(135deg, #a8caba 0%, #5d4e6d 100%); margin-left: 5px;"><i class="fas fa-tools"></i> Manuten√ß√£o</button>` : ''
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        async function removeDriver(ambulanciaId) {
            if (!confirm('Tem certeza que deseja remover o motorista desta ambul√¢ncia?')) return;

            try {
                const response = await fetch(`/ambulancias/${ambulanciaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motoristaId: null })
                });

                if (response.ok) {
                    showMessage('‚úì Motorista removido com sucesso!', 'green');
                    fetchAmbulancias();
                } else {
                    showMessage('‚úó Erro ao remover motorista.', 'red');
                }
            } catch (error) {
                showMessage('‚úó Erro ao remover motorista.', 'red');
                console.error('Erro:', error);
            }
        }

        async function setMaintenance(ambulanciaId) {
            if (!confirm('Tem certeza que deseja colocar esta ambul√¢ncia em manuten√ß√£o?')) return;

            try {
                const response = await fetch(`/ambulancias/${ambulanciaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Em manuten√ß√£o' })
                });

                if (response.ok) {
                    showMessage('‚úì Ambul√¢ncia colocada em manuten√ß√£o!', 'green');
                    fetchAmbulancias();
                } else {
                    showMessage('‚úó Erro ao alterar status.', 'red');
                }
            } catch (error) {
                showMessage('‚úó Erro ao alterar status.', 'red');
                console.error('Erro:', error);
            }
        }

        function assignDriver(ambulanciaId) {
            // Redireciona para a p√°gina de associa√ß√£o
            window.location.href = `/ambulancia_motorista.html`;
        }

        function showMessage(text, color) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.style.color = color;
            messageDiv.style.fontWeight = 'bold';
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }

        // Carrega ambul√¢ncias ao carregar a p√°gina
        fetchAmbulancias();
    </script>
</body>
</html>
