<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocaliza칞칚o - Ambul칙ncias</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="has-sidebar">
    <!-- Top Header Bar -->
    <div class="top-header">
        <div class="header-left">
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/home.html" class="home-btn">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="header-right">
            <div class="user-header-profile">
                <div class="user-avatar-small">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info-small">
                    <span class="user-name">Admin User</span>
                    <span class="user-email">admin@medilink.com</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar (injected by JavaScript) -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

    

    <div class="container">
        <h1>Geolocaliza칞칚o das Ambul칙ncias 游뚬</h1>

        <div id="map"></div>
    </div>

    <script>
        // Posi칞칚o do usu치rio (simulada - pode ser substitu칤da por geolocaliza칞칚o real)
        let userPosition = { lat: -23.5505, lng: -46.6333 };
        
        // Vari치vel para armazenar ambul칙ncias do banco de dados
        let ambulancias = [];
        
        // Fun칞칚o para calcular dist칙ncia entre dois pontos (Haversine)
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Dist칙ncia em km
        }
        
        // Fun칞칚o para estimar tempo baseado na dist칙ncia
        function estimarTempo(distanciaKm) {
            // Assumindo velocidade m칠dia de 40 km/h em 치rea urbana
            const minutos = Math.round((distanciaKm / 40) * 60);
            return minutos < 1 ? 1 : minutos; // M칤nimo 1 minuto
        }
        
        // Fun칞칚o para carregar ambul칙ncias do banco de dados
        async function carregarAmbulanciasDoBanco() {
            try {
                const response = await fetch('/ambulancias/combined');
                if (!response.ok) {
                    throw new Error('Erro ao carregar ambul칙ncias');
                }
                
                const ambulanciasDB = await response.json();
                
                // Filtrar apenas ambul칙ncias com latitude/longitude definidas
                ambulancias = ambulanciasDB
                    .filter(amb => amb.latitude && amb.longitude)
                    .map(amb => {
                        const distanciaKm = calcularDistancia(
                            userPosition.lat, userPosition.lng,
                            amb.latitude, amb.longitude
                        );
                        const tempoMin = estimarTempo(distanciaKm);
                        
                        return {
                            id: amb.id,
                            placa: amb.placa,
                            latitude: amb.latitude,
                            longitude: amb.longitude,
                            status: amb.status || 'Dispon칤vel',
                            motorista: amb.motoristaNome || 'N칚o atribu칤do',
                            telefone: amb.motoristaTelefone || '',
                            modelo: amb.modelo,
                            capacidade: amb.capacidade,
                            distancia: distanciaKm.toFixed(1) + ' km',
                            tempo: tempoMin + ' min'
                        };
                    })
                    // Ordenar por dist칙ncia (mais pr칩ximas primeiro)
                    .sort((a, b) => parseFloat(a.distancia) - parseFloat(b.distancia));
                
                console.log('Ambul칙ncias carregadas do banco:', ambulancias);
                
                // Se n칚o h치 ambul칙ncias no banco, usar simula칞칚o
                if (ambulancias.length === 0) {
                    console.warn('Nenhuma ambul칙ncia encontrada no banco. Usando simula칞칚o.');
                    usarAmbulanciasFicticias();
                } else {
                    // Reinicializar mapa com dados reais
                    if (typeof initMap === 'function') {
                        initMap();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar ambul칙ncias:', error);
                console.warn('Usando ambul칙ncias fict칤cias devido ao erro.');
                usarAmbulanciasFicticias();
            }
        }
        
        // Fun칞칚o fallback com ambul칙ncias fict칤cias
        function usarAmbulanciasFicticias() {
            ambulancias = [
                { 
                    placa: 'ABC-1234', 
                    latitude: -23.5510, 
                    longitude: -46.6338, 
                    status: 'Dispon칤vel',
                    motorista: 'Jo칚o Silva',
                    telefone: '(11) 98765-4321',
                    modelo: 'Mercedes Sprinter',
                    capacidade: 4,
                    distancia: '0.8 km',
                    tempo: '3 min'
                },
                { 
                    placa: 'DEF-5678', 
                    latitude: -23.5515, 
                    longitude: -46.6343, 
                    status: 'Dispon칤vel',
                    motorista: 'Maria Santos',
                    telefone: '(11) 98765-4322',
                    modelo: 'Fiat Ducato',
                    capacidade: 3,
                    distancia: '1.2 km',
                    tempo: '5 min'
                },
                { 
                    placa: 'GHI-9012', 
                    latitude: -23.5502, 
                    longitude: -46.6328, 
                    status: 'Dispon칤vel',
                    motorista: 'Carlos Oliveira',
                    telefone: '(11) 98765-4323',
                    modelo: 'Mercedes Sprinter',
                    capacidade: 6,
                    distancia: '0.5 km',
                    tempo: '2 min'
                }
            ];
        }

        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: userPosition,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Marcador do usu치rio (sua posi칞칚o)
            const userMarker = new google.maps.Marker({
                position: userPosition,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#667eea',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                },
                title: 'Voc칡 est치 aqui',
                zIndex: 1000
            });

            // InfoWindow para o usu치rio
            const userInfoWindow = new google.maps.InfoWindow({
                content: `<div style="padding: 10px;"><strong>游늸 Voc칡 est치 aqui</strong></div>`
            });

            userMarker.addListener('click', () => {
                userInfoWindow.open(map, userMarker);
            });

            // Marcadores das ambul칙ncias pr칩ximas
            const markers = ambulancias.map(ambulancia => {
                // 칈cone personalizado baseado no status
                const iconColor = ambulancia.status === 'Dispon칤vel' ? '#10b981' : '#f59e0b';
                
                const marker = new google.maps.Marker({
                    position: { lat: ambulancia.latitude, lng: ambulancia.longitude },
                    map: map,
                    icon: {
                        url: `data:image/svg+xml;utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20">游뚬</text></svg>`,
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    title: `Ambul칙ncia ${ambulancia.placa}`,
                    animation: google.maps.Animation.DROP
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 15px; min-width: 220px;">
                            <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 1.1rem;">游뚬 ${ambulancia.placa}</h3>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${iconColor}">${ambulancia.status}</span></p>
                            <p style="margin: 5px 0;"><strong>Motorista:</strong> ${ambulancia.motorista}</p>
                            <p style="margin: 5px 0;"><strong>Dist칙ncia:</strong> ${ambulancia.distancia}</p>
                            <p style="margin: 5px 0;"><strong>Tempo estimado:</strong> ${ambulancia.tempo}</p>
                            ${ambulancia.status === 'Dispon칤vel' ? '<button onclick="solicitarAmbulancia(\'' + ambulancia.placa + '\')" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Solicitar Esta Ambul칙ncia</button>' : ''}
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                return { marker, ambulancia };
            });

            // Simula칞칚o de movimento das ambul칙ncias
            setInterval(() => {
                markers.forEach(({ marker, ambulancia }) => {
                    // Movimento aleat칩rio pequeno para simular tr칙nsito
                    ambulancia.latitude += (Math.random() - 0.5) * 0.0005;
                    ambulancia.longitude += (Math.random() - 0.5) * 0.0005;
                    
                    marker.setPosition(new google.maps.LatLng(ambulancia.latitude, ambulancia.longitude));
                });
            }, 3000);
        }

        // Fun칞칚o para solicitar ambul칙ncia
        function solicitarAmbulancia(placa) {
            const ambulancia = ambulancias.find(a => a.placa === placa);
            if (ambulancia) {
                if (confirm(`Deseja solicitar a ambul칙ncia ${placa}?\n\nMotorista: ${ambulancia.motorista}\nTempo estimado: ${ambulancia.tempo}\nDist칙ncia: ${ambulancia.distancia}`)) {
                    alert(`Solicita칞칚o enviada! A ambul칙ncia ${placa} foi acionada e est치 a caminho.\n\nVoc칡 receber치 atualiza칞칫es em tempo real.`);
                    // Aqui voc칡 pode redirecionar para a p치gina de tracking
                    // window.location.href = 'cliente_track.html?ambulancia=' + placa;
                }
            }
        }

        // Carregar ambul칙ncias do banco ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            carregarAmbulanciasDoBanco();
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIz6iI0blYnCpoGhjstXvYbxdVdyHRWpo&callback=carregarAmbulanciasDoBanco"></script>
    </main>

    <script src="sidebar.js"></script>
    <script>
        // Inject sidebar
        document.getElementById('sidebar-container').innerHTML = createSidebar('geolocation');
        
        // Apply saved theme
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
        }
        
        // Apply accessibility settings
        const highContrast = localStorage.getItem('highContrast') === 'true';
        const largeText = localStorage.getItem('largeText') === 'true';
        
        if (highContrast) {
            document.body.classList.add('high-contrast');
        }
        if (largeText) {
            document.body.classList.add('large-text');
        }
    </script>
</body>
</html>
